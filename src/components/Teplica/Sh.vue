<template>
    <div class="scheme-sh">
        <svg
                xmlns:dc="http://purl.org/dc/elements/1.1/"
                xmlns:cc="http://creativecommons.org/ns#"
                xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
                xmlns:svg="http://www.w3.org/2000/svg"
                xmlns="http://www.w3.org/2000/svg"
                xmlns:xlink="http://www.w3.org/1999/xlink"
                xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
                width="210.8434mm"
                height="220.04291mm"
                viewBox="0 0 210.8434 220.04291"
                version="1.1"
                id="svg8"
                inkscape:version="0.92.5 (2060ec1f9f, 2020-04-08)"
                sodipodi:docname="gryadka-Sh.svg"
                inkscape:export-filename="/home/lup/Рабочий стол/грядки/gryadka-Sh.png"
                inkscape:export-xdpi="110"
                inkscape:export-ydpi="110">
            <defs id="defs2">
                <marker
                        id="ArrowStartVertical"
                        orient="auto"
                        refY="0"
                        refX="0"
                        style="overflow:visible">
                    <path
                            id="path1120"
                            d="M 0,0 5,-5 -12.5,0 5,5 Z"
                            style="fill:#da3a3a;fill-opacity:1;fill-rule:evenodd;stroke:#da3a3a;stroke-width:1.00000003pt;stroke-opacity:1"
                            transform="matrix(0.8,0,0,0.8,10,0)"
                            inkscape:connector-curvature="0" />
                </marker>
                <marker
                        id="ArrowEndVertical"
                        orient="auto"
                        refY="0"
                        refX="0"
                        style="overflow:visible">
                    <path
                            id="path1123"
                            d="M 0,0 5,-5 -12.5,0 5,5 Z"
                            style="fill:#da3a3a;fill-opacity:1;fill-rule:evenodd;stroke:#da3a3a;stroke-width:1.00000003pt;stroke-opacity:1"
                            transform="matrix(-0.8,0,0,-0.8,-10,0)"
                            inkscape:connector-curvature="0" />
                </marker>
                <marker
                        orient="auto"
                        refY="0"
                        refX="0"
                        id="ArrowStartHorizontal"
                        style="overflow:visible">
                    <path
                            inkscape:connector-curvature="0"
                            id="path1120-2"
                            d="M 0,0 5,-5 -12.5,0 5,5 Z"
                            style="fill:#da3a3a;fill-opacity:1;fill-rule:evenodd;stroke:#da3a3a;stroke-width:1.00000003pt;stroke-opacity:1"
                            transform="matrix(0.8,0,0,0.8,10,0)" />
                </marker>
                <marker
                        orient="auto"
                        refY="0"
                        refX="0"
                        id="ArrowEndHorizontal"
                        style="overflow:visible">
                    <path
                            inkscape:connector-curvature="0"
                            id="path1123-6"
                            d="M 0,0 5,-5 -12.5,0 5,5 Z"
                            style="fill:#da3a3a;fill-opacity:1;fill-rule:evenodd;stroke:#da3a3a;stroke-width:1.00000003pt;stroke-opacity:1"
                            transform="matrix(-0.8,0,0,-0.8,-10,0)" />
                </marker>
            </defs>
            <sodipodi:namedview
                    id="base"
                    pagecolor="#ffffff"
                    bordercolor="#666666"
                    borderopacity="1.0"
                    inkscape:pageopacity="0.0"
                    inkscape:pageshadow="2"
                    inkscape:zoom="1.4142136"
                    inkscape:cx="381.62887"
                    inkscape:cy="179.76958"
                    inkscape:document-units="mm"
                    inkscape:current-layer="layer1"
                    showgrid="false"
                    inkscape:object-paths="false"
                    showguides="true"
                    inkscape:guide-bbox="true"
                    fit-margin-top="0"
                    fit-margin-left="0"
                    fit-margin-right="0"
                    fit-margin-bottom="0"
                    inkscape:window-width="1848"
                    inkscape:window-height="1016"
                    inkscape:window-x="72"
                    inkscape:window-y="27"
                    inkscape:window-maximized="1"
                    inkscape:snap-midpoints="true"
                    inkscape:snap-intersection-paths="true">
                <sodipodi:guide
                        position="29.934187,-8.9802558"
                        orientation="1,0"
                        id="guide8362"
                        inkscape:locked="false" />
                <sodipodi:guide
                        position="179.9793,-23.198994"
                        orientation="1,0"
                        id="guide8366"
                        inkscape:locked="false" />
                <sodipodi:guide
                        position="46.023813,29.934186"
                        orientation="0,1"
                        id="guide8395"
                        inkscape:locked="false" />
            </sodipodi:namedview>
            <metadata
                    id="metadata5">
                <rdf:RDF>
                    <cc:Work
                            rdf:about="">
                        <dc:format>image/svg+xml</dc:format>
                        <dc:type
                                rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
                        <dc:title />
                    </cc:Work>
                </rdf:RDF>
            </metadata>
            <g
                    inkscape:label="Layer 1"
                    inkscape:groupmode="layer"
                    id="layer1"
                    transform="translate(0.30449593,-5.3929499)">

                <rect id="g1_left_bort" :width="bortsPx[0]['left'].w" :height="bortsPx[0]['left'].h" :x="bortsPx[0]['left'].x" :y="bortsPx[0]['left'].y"/>
                <rect id="g1_bottom_bort" :width="bortsPx[0]['bottom'].w" :height="bortsPx[0]['bottom'].h" :x="bortsPx[0]['bottom'].x" :y="bortsPx[0]['bottom'].y"/>
                <rect id="g1_right_bort" :width="bortsPx[0]['right'].w" :height="bortsPx[0]['right'].h" :x="bortsPx[0]['right'].x" :y="bortsPx[0]['right'].y"/>
                <rect id="g4_bottom_bort_left" :width="bortsPx[3]['bottomLeft'].w" :height="bortsPx[3]['bottomLeft'].h" :x="bortsPx[3]['bottomLeft'].x" :y="bortsPx[3]['bottomLeft'].y"/>
                <rect id="g4_left_bort" :width="bortsPx[3]['left'].w" :height="bortsPx[3]['left'].h" :x="bortsPx[3]['left'].x" :y="bortsPx[3]['left'].y"/>
                <rect id="g1_top_bort" :width="bortsPx[0]['top'].w" :height="bortsPx[0]['top'].h" :x="bortsPx[0]['top'].x" :y="bortsPx[0]['top'].y"/>
                <rect id="g2_left_bort" :width="bortsPx[1]['left'].w" :height="bortsPx[1]['left'].h" :x="bortsPx[1]['left'].x" :y="bortsPx[1]['left'].y"/>
                <rect id="g2_bottom_bort" :width="bortsPx[1]['bottom'].w" :height="bortsPx[1]['bottom'].h" :x="bortsPx[1]['bottom'].x" :y="bortsPx[1]['bottom'].y"/>
                <rect id="g2_right_bort" :width="bortsPx[1]['right'].w" :height="bortsPx[1]['right'].h" :x="bortsPx[1]['right'].x" :y="bortsPx[1]['right'].y"/>
                <rect id="g4_bottom_bort_right" :width="bortsPx[3]['bottomRight'].w" :height="bortsPx[3]['bottomRight'].h" :x="bortsPx[3]['bottomRight'].x" :y="bortsPx[3]['bottomRight'].y"/>
                <rect id="g3_left_bort" :width="bortsPx[2]['left'].w" :height="bortsPx[2]['left'].h" :x="bortsPx[2]['left'].x" :y="bortsPx[2]['left'].y"/>
                <rect id="g3_bottom_bort" :width="bortsPx[2]['bottom'].w" :height="bortsPx[2]['bottom'].h" :x="bortsPx[2]['bottom'].x" :y="bortsPx[2]['bottom'].y"/>
                <rect id="g3_right_bort" :width="bortsPx[2]['right'].w" :height="bortsPx[2]['right'].h" :x="bortsPx[2]['right'].x" :y="bortsPx[2]['right'].y"/>
                <rect id="g4_right_bort" :width="bortsPx[3]['right'].w" :height="bortsPx[3]['right'].h" :x="bortsPx[3]['right'].x" :y="bortsPx[3]['right'].y"/>
                <rect id="g3_top_bort" :width="bortsPx[2]['top'].w" :height="bortsPx[2]['top'].h" :x="bortsPx[2]['top'].x" :y="bortsPx[2]['top'].y"/>
                <rect id="g4_top_bort" :width="bortsPx[3]['top'].w" :height="bortsPx[3]['top'].h" :x="bortsPx[3]['top'].x" :y="bortsPx[3]['top'].y"/>

                <path v-for="(support, index) in supportD" :d="support" :id="'gx_support_'+index" :key="'gx_support_'+index" />

                <path id="g2_left_arrow" :d="arrowsD[1]['left']" @mousedown="event => startMove(event, 1, 'left')" @touchstart.prevent="event => startMove(event, 1, 'left')"/>
                <path id="g2_right_arrow" :d="arrowsD[1]['right']" @mousedown="event => startMove(event, 1, 'right')" @touchstart.prevent="event => startMove(event, 1, 'right')"/>
                <path id="g3_left_arrow" :d="arrowsD[2]['left']" @mousedown="event => startMove(event, 2, 'left')" @touchstart.prevent="event => startMove(event, 2, 'left')"/>
                <path id="g3_right_arrow" :d="arrowsD[2]['right']" @mousedown="event => startMove(event, 3, 'right')" @touchstart.prevent="event => startMove(event, 3, 'right')"/>
                <path id="g1_right_arrow" :d="arrowsD[0]['right']" @mousedown="event => startMove(event, 0, 'right')" @touchstart.prevent="event => startMove(event, 0, 'right')"/>
                <!--path id="g1_left_arrow" :d="arrowsD[0]['left']" @mousedown="event => startMove(event, 3, 'left')" @touchstart.prevent="event => startMove(event, 3, 'left')"/-->
                <path id="g1_bottom_arrow" :d="arrowsD[0]['bottom']" @mousedown="event => startMove(event, 0, 'bottom')" @touchstart.prevent="event => startMove(event, 0, 'bottom')"/>
                <path id="g2_bottom_arrow" :d="arrowsD[1]['bottom']" @mousedown="event => startMove(event, 1, 'bottom')" @touchstart.prevent="event => startMove(event, 1, 'bottom')"/>
                <path id="g3_bottom_arrow" :d="arrowsD[2]['bottom']" @mousedown="event => startMove(event, 2, 'bottom')" @touchstart.prevent="event => startMove(event, 2, 'bottom')"/>
                <path id="g4_bottom_arrow_left" :d="arrowsD[3]['bottomLeft']" @mousedown="event => startMove(event, 3, 'bottomLeft')" @touchstart.prevent="event => startMove(event, 3, 'bottomLeft')"/>
                <path id="g4_bottom_arrow_right" :d="arrowsD[3]['bottomRight']" @mousedown="event => startMove(event, 3, 'bottomRight')" @touchstart.prevent="event => startMove(event, 3, 'bottomRight')"/>

                <text v-for="(title, index) in lengthTitles" :key="'length_title'+index"
                        :id="'g'+(index+1)+'_length_title'"
                        :x="textPositions['length'][index].title.x" :y="textPositions['length'][index].title.y"
                >
                    {{title}}
                </text>
                <text v-for="(text, index) in lengthTexts" :key="'length_text'+index"
                        :id="'g'+(index+1)+'_length_text'"
                        :x="textPositions['length'][index].text.x" :y="textPositions['length'][index].text.y"
                >
                    {{text}}
                </text>

                <text v-for="(title, index) in widthTitles" :key="'width_title'+index"
                        :id="'g'+(index+1)+'_width_title'"
                        :x="textPositions['width'][index].title.x" :y="textPositions['width'][index].title.y"
                >
                    {{title}}
                </text>
                <text v-for="(text, index) in widthTexts" :key="'width_text'+index"
                        :id="'g'+(index+1)+'_width_text'"
                        :x="textPositions['width'][index].text.x" :y="textPositions['width'][index].text.y"
                >
                    {{text}}
                </text>
            </g>
        </svg>
    </div>
</template>

<script>
    function getMousePos(mouseEvent, point) {
        point.x = (mouseEvent.clientX);
        point.y = (mouseEvent.clientY);
    }

    function getTouchPos(touchEvent, point) {
        point.x = (touchEvent.touches[0].clientX);
        point.y = (touchEvent.touches[0].clientY);
    }

    export default {
        name: "TeplicaSh",
        data() {
            //Все размеры внешние, т.е. содержат ширину бортов

            let pixelToCm = 62/37.6803905;
            let cmToPixel = 1/pixelToCm;

            let bortPixelToCm = 1.5/5.735;
            let bortCmToPixel = 1/bortPixelToCm;

            return {
                pixelToCm,
                cmToPixel,
                bortPixelToCm,
                bortCmToPixel,
                minWidth: 50,
                minLength: 100,
                titleTextSizePx: 4.93888903,
                numbersTextSizePx: 10.58333302,
                bortWidthCm: 1.5,
                arrowWidthPx: 21.94932,
                leftStartPx: 8.3789015,
                topStartPx: 14.552918,
                gryadkiBase: [
                    {widthCm: 62, lengthCm: 195},
                    {widthCm: 62, lengthCm: 145},
                    {widthCm: 62, lengthCm: 195},
                    {widthCm: 62, lengthCm: 300},
                ]
            }
        },
        methods: {
            widthInPixels(cm) {
                return cm * this.cmToPixel;
            },
            widthInCm(pixels) {
                return pixels * this.pixelToCm;
            },
            bortWidthInPixels(cm) {
                return cm * this.bortCmToPixel;
            },
            textLength(text, fontSize) {
                let magicLetterLengthInPx = fontSize * 2.5;
                return this.pixelsToMM( text.length * magicLetterLengthInPx );
            },
            pixelsToInches(px) {
                return px * (1/96);
            },
            inchesToPixels(inches) {
                return inches / (1/96);
            },
            inchesToMM(inches) {
                return inches * 25.4;
            },
            mmToInches(mm) {
                return mm / 25.4;
            },
            pixelsToMM(px) {
                //82.96 px = 21.94932 mm
                return this.inchesToMM( this.pixelsToInches(px) );
            },
            mmToPixels(mm) {
                return this.inchesToPixels( this.mmToInches(mm) );
            },
            textHeight(px) {
                let magicCoeff = 3.5;
                return this.pixelsToMM(px) * magicCoeff;
            },
            pointToPath(point) {
                let {start, end} = point;
                return `M ${start.x} ${start.y} L ${end.x} ${end.y}`;
            },
            startMove(evt, grIndex, arrowType) {
                const touch = (evt.type === "touchstart")
                if (!touch && evt.button !== 0) return;
                const events = touch ? {
                    move: "touchmove",
                    stop: "touchend"
                } : {
                    move: "mousemove",
                    stop: "mouseup"
                }
                const elem = evt.currentTarget.closest("svg");
                const point = elem.createSVGPoint();
                const transform = elem.getScreenCTM().inverse();
                const grSize = this.gryadkiBase[grIndex];
                const getPos = touch ? getTouchPos : getMousePos;

                let moving = true;
                let newPt;

                const updateFn = () => {
                    let isNotSwappedLengthWidth = grIndex !== 3;
                    let isVertical = ['bottom', 'bottomLeft', 'bottomRight'].indexOf(arrowType) !== -1;
                    if (moving) requestAnimationFrame(updateFn);

                    let bort = this.bortsPx[grIndex][arrowType];
                    newPt = point.matrixTransform(transform);
                    let coordType = 'x';
                    let propType = isNotSwappedLengthWidth ? 'widthCm' : 'lengthCm';
                    let baseCoord = bort.x + bort.w/2;
                    let minSize = isNotSwappedLengthWidth ? this.minWidth : this.minHeight;

                    let isInverted = arrowType === 'right' || isVertical;

                    if (isVertical) {
                        coordType = 'y';
                        propType = isNotSwappedLengthWidth ? 'lengthCm' : 'widthCm';
                        baseCoord = bort.y + bort.h/2;
                        minSize = isNotSwappedLengthWidth ? this.minHeight : this.minWidth;
                    }

                    let delta = isInverted
                        ? newPt[coordType] - baseCoord
                        : baseCoord - newPt[coordType];
                    let deltaCm = this.widthInCm( this.pixelsToMM(delta) );
                    let newSize = grSize[propType] + deltaCm;
                    if (newSize < minSize) {
                        newSize = minSize;
                    }

                    this.$set( this.gryadkiBase[grIndex], propType, newSize );
                }
                const moveFn = (evt) => getPos(evt, point)
                const stopFn = () => {
                    moving = false;
                    elem.removeEventListener(events.move, moveFn);
                    elem.removeEventListener(events.stop, stopFn);
                }

                requestAnimationFrame(updateFn);
                moveFn(evt);

                elem.addEventListener(events.move, moveFn);
                elem.addEventListener(events.stop, stopFn);
            }
        },
        computed: {
            prWidthPx() {
                let [gr1, gr2, gr3, gr4] = this.gryadkiBase;
                return this.widthInPixels(gr4.lengthCm - gr1.widthCm - gr2.widthCm - gr3.widthCm)/2;
            },
            gryadkiPx() {
                let [gr1, gr2, gr3, gr4] = this.gryadkiBase;
                let grTopPx = this.topStartPx + this.widthInPixels(gr4.widthCm);
                let prWidthPx = this.prWidthPx;

                return [
                    {
                        width: this.widthInPixels(gr1.widthCm),
                        length: this.widthInPixels(gr1.lengthCm),
                        left: this.leftStartPx,
                        top: grTopPx
                    },
                    {
                        width: this.widthInPixels(gr2.widthCm),
                        length: this.widthInPixels(gr2.lengthCm),
                        left: this.leftStartPx + this.widthInPixels(gr1.widthCm) + prWidthPx,
                        top: grTopPx
                    },
                    {
                        width: this.widthInPixels(gr3.widthCm),
                        length: this.widthInPixels(gr3.lengthCm),
                        left: this.leftStartPx + this.widthInPixels(gr1.widthCm) + this.widthInPixels(gr2.widthCm) + 2 * prWidthPx,
                        top: grTopPx
                    },
                    {
                        width: this.widthInPixels(gr4.widthCm),
                        length: this.widthInPixels(gr4.lengthCm),
                        left: this.leftStartPx,
                        top: this.topStartPx
                    },
                ]
            },
            bortsPx() {
                let bortWidthPx = this.bortWidthInPixels(this.bortWidthCm);
                let gryadkiPx = this.gryadkiPx;
                let prWidthPx = this.prWidthPx;

                return [
                    {
                        left: {w: bortWidthPx, h: gryadkiPx[0].length, x: gryadkiPx[0].left, y: gryadkiPx[0].top},
                        bottom: {w: gryadkiPx[0].width - 2*bortWidthPx, h: bortWidthPx, x: gryadkiPx[0].left + bortWidthPx, y: gryadkiPx[0].top + gryadkiPx[0].length - bortWidthPx},
                        right: {w: bortWidthPx, h: gryadkiPx[0].length, x: gryadkiPx[0].left + gryadkiPx[0].width - bortWidthPx, y: gryadkiPx[0].top},
                        top: {w: gryadkiPx[0].width - 2*bortWidthPx, h: bortWidthPx, x: gryadkiPx[0].left + bortWidthPx, y: gryadkiPx[3].top},
                    },
                    {
                        left: {w: bortWidthPx, h: gryadkiPx[1].length, x: gryadkiPx[1].left, y: gryadkiPx[1].top},
                        bottom: {w: gryadkiPx[1].width - 2*bortWidthPx, h: bortWidthPx, x: gryadkiPx[1].left + bortWidthPx, y: gryadkiPx[1].top + gryadkiPx[1].length - bortWidthPx},
                        right: {w: bortWidthPx, h: gryadkiPx[1].length, x: gryadkiPx[1].left + gryadkiPx[1].width - bortWidthPx, y: gryadkiPx[1].top},
                        top: {w: gryadkiPx[1].width - 2*bortWidthPx, h: bortWidthPx, x: gryadkiPx[1].left + bortWidthPx, y: gryadkiPx[3].top},
                    },
                    {
                        left: {w: bortWidthPx, h: gryadkiPx[2].length, x: gryadkiPx[2].left, y: gryadkiPx[2].top},
                        bottom: {w: gryadkiPx[2].width - 2*bortWidthPx, h: bortWidthPx, x: gryadkiPx[2].left + bortWidthPx, y: gryadkiPx[2].top + gryadkiPx[2].length - bortWidthPx},
                        right: {w: bortWidthPx, h: gryadkiPx[2].length, x: gryadkiPx[2].left + gryadkiPx[2].width - bortWidthPx, y: gryadkiPx[2].top},
                        top: {w: gryadkiPx[2].width - 2*bortWidthPx, h: bortWidthPx, x: gryadkiPx[2].left + bortWidthPx, y: gryadkiPx[3].top},
                    },
                    {
                        left: {w: bortWidthPx, h: gryadkiPx[3].width, x: gryadkiPx[3].left, y: gryadkiPx[3].top},
                        bottomLeft: {w: prWidthPx + 2*bortWidthPx, h: bortWidthPx, x: gryadkiPx[0].left + gryadkiPx[0].width - bortWidthPx, y: gryadkiPx[3].top + gryadkiPx[3].width - bortWidthPx},
                        bottomRight: {w: prWidthPx + 2*bortWidthPx, h: bortWidthPx, x: gryadkiPx[1].left + gryadkiPx[1].width - bortWidthPx, y: gryadkiPx[3].top + gryadkiPx[3].width - bortWidthPx},
                        right: {w: bortWidthPx, h: gryadkiPx[3].width, x: gryadkiPx[2].left + gryadkiPx[2].width - bortWidthPx, y: gryadkiPx[3].top},
                        top: {w: gryadkiPx[1].width + 2 * prWidthPx + 2*bortWidthPx, h: bortWidthPx, x: gryadkiPx[0].left + gryadkiPx[0].width - bortWidthPx, y: gryadkiPx[3].top},
                    },
                ]
            },

            grMiddlesPx() {
                let [br1, br2, br3, br4] = this.bortsPx;
                return [
                    {x: br1.bottom.x + br1.bottom.w/2, y: br1.left.y+br1.left.h/2},
                    {x: br2.bottom.x + br2.bottom.w/2, y: br2.left.y+br2.left.h/2},
                    {x: br3.bottom.x + br3.bottom.w/2, y: br3.left.y+br3.left.h/2},
                    {x: br2.bottom.x + br2.bottom.w/2, y: br4.left.y+br4.left.h/2},
                ]
            },
            arrowsPx() {
                let [br1, br2, br3, br4] = this.bortsPx;
                let grMiddles = this.grMiddlesPx;

                let prMiddles = [
                    {x: br4.bottomLeft.x + br4.bottomLeft.w/2, y: br4.bottomLeft.y + br4.bottomLeft.h/2},
                    {x: br4.bottomRight.x + br4.bottomRight.w/2, y: br4.bottomRight.y + br4.bottomRight.h/2},
                ];

                let arrowWidth = this.arrowWidthPx;

                return [
                    {
                        left: { start: {x: br1.left.x+br1.left.w/2 - arrowWidth/2, y: grMiddles[0].y}, end: {x: br1.left.x+br1.left.w/2 + arrowWidth/2, y: grMiddles[0].y} },
                        right: { start: {x: br1.right.x+br1.right.w/2 - arrowWidth/2, y: grMiddles[0].y}, end: {x: br1.right.x+br1.right.w/2 + arrowWidth/2, y: grMiddles[0].y} },
                        bottom: { start: {x: grMiddles[0].x, y: br1.bottom.y + br1.bottom.h/2-arrowWidth/2}, end: {x: grMiddles[0].x, y: br1.bottom.y + br1.bottom.h/2+arrowWidth/2} },
                    },
                    {
                        left: { start: {x: br2.left.x+br2.left.w/2 - arrowWidth/2, y: grMiddles[1].y}, end: {x: br2.left.x+br2.left.w/2 + arrowWidth/2, y: grMiddles[1].y} },
                        right: { start: {x: br2.right.x+br2.right.w/2 - arrowWidth/2, y: grMiddles[1].y}, end: {x: br2.right.x+br2.right.w/2 + arrowWidth/2, y: grMiddles[1].y} },
                        bottom: { start: {x: grMiddles[1].x, y: br2.bottom.y + br2.bottom.h/2-arrowWidth/2}, end: {x: grMiddles[1].x, y: br2.bottom.y + br2.bottom.h/2+arrowWidth/2} },
                    },
                    {
                        left: { start: {x: br3.left.x+br3.left.w/2 - arrowWidth/2, y: grMiddles[2].y}, end: {x: br3.left.x+br3.left.w/2 + arrowWidth/2, y: grMiddles[2].y} },
                        right: { start: {x: br3.right.x+br3.right.w/2 - arrowWidth/2, y: grMiddles[2].y}, end: {x: br3.right.x+br3.right.w/2 + arrowWidth/2, y: grMiddles[2].y} },
                        bottom: { start: {x: grMiddles[2].x, y: br3.bottom.y + br3.bottom.h/2-arrowWidth/2}, end: {x: grMiddles[2].x, y: br3.bottom.y + br3.bottom.h/2+arrowWidth/2} },
                    },
                    {
                        bottomLeft: { start: {x: prMiddles[0].x, y: prMiddles[0].y-arrowWidth/2}, end: {x: prMiddles[0].x, y: prMiddles[0].y+arrowWidth/2} },
                        bottomRight: { start: {x: prMiddles[1].x, y: prMiddles[1].y-arrowWidth/2}, end: {x: prMiddles[1].x, y: prMiddles[1].y+arrowWidth/2} },
                    }
                ];
            },
            arrowsD() {
                return this.arrowsPx.map( grArrows => {
                    let arrowTypes = Object.keys(grArrows);
                    let arrowsD = {};

                    arrowTypes.forEach(arrowType => {
                        arrowsD[arrowType] = this.pointToPath( grArrows[arrowType] );
                    });

                    return arrowsD;
                });
            },

            supportPx() {
                let br4 = this.bortsPx[3];

                return [
                    {start: {x: br4.left.x + br4.left.w, y: br4.bottomLeft.y + br4.bottomLeft.h}, end: {x: br4.bottomLeft.x, y: br4.bottomLeft.y + br4.bottomLeft.h}},
                    {start: {x: br4.bottomLeft.x + br4.bottomLeft.w, y: br4.bottomLeft.y + br4.bottomLeft.h}, end: {x: br4.bottomRight.x, y: br4.bottomLeft.y + br4.bottomLeft.h}},
                    {start: {x: br4.bottomRight.x + br4.bottomRight.w, y: br4.bottomRight.y + br4.bottomRight.h}, end: {x: br4.right.x, y: br4.bottomRight.y + br4.bottomRight.h}},
                    {start: {x: br4.bottomLeft.x, y: br4.bottomLeft.y}, end: {x: br4.bottomLeft.x, y: br4.top.y + br4.top.h}},
                    {start: {x: br4.bottomRight.x + br4.bottomRight.w, y: br4.bottomRight.y}, end: {x: br4.bottomRight.x + br4.bottomRight.w, y: br4.top.y + br4.top.h}},
                ]
            },
            supportD() {
                return this.supportPx.map( this.pointToPath );
            },

            widthTitles() {
                return [1, 2, 3, 4].map( num => 'Ширина '+num );
            },
            lengthTitles() {
                return ['Длина 1', 'Проход', 'Длина 3'];
            },
            widthTexts() {
                return this.gryadkiBase.map( (gryadka, index) => Math.round( index < 4 ? gryadka.widthCm : gryadka.lengthCm ).toString() );
            },
            lowestY() {
                let borts = this.bortsPx;
                return Math.max(
                    borts[0].bottom.y+borts[0].bottom.h,
                    borts[1].bottom.y+borts[1].bottom.h,
                    borts[2].bottom.y+borts[2].bottom.h
                );
            },
            lowestCm() {
                return Math.max(
                    this.gryadkiBase[0].lengthCm,
                    this.gryadkiBase[1].lengthCm,
                    this.gryadkiBase[2].lengthCm,
                )
            },
            lengthTexts() {
                let lengths = this.gryadkiBase.map( (gryadka, index) => Math.round( index < 4 ? gryadka.lengthCm : gryadka.widthCm ).toString() );
                let prSizeCm = this.lowestCm - this.gryadkiBase[1].lengthCm;
                lengths[1] = Math.round(prSizeCm).toString();

                return lengths;
            },
            textPositions() {
                let grMiddles = this.grMiddlesPx;
                let borts = this.bortsPx;

                let widthTitleSizes = this.widthTitles.map( title => this.textLength(title, this.titleTextSizePx) );
                let lengthTitleSizes = this.lengthTitles.map( title => this.textLength(title, this.titleTextSizePx) );
                let widthTextSizes = this.widthTexts.map( text => this.textLength(text, this.numbersTextSizePx) );
                let lengthTextSizes = this.lengthTexts.map( text => this.textLength(text, this.numbersTextSizePx) );

                let textPaddingPx = 0;
                let arrowPaddingPx = 2;
                let arrowWidth = this.arrowWidthPx;

                let textYShift = arrowPaddingPx;
                let titleYShift = textYShift + textPaddingPx + this.textHeight(this.numbersTextSizePx);
                let allTextHeight = this.textHeight(this.numbersTextSizePx) + this.textHeight(this.titleTextSizePx);

                let lowestY = this.lowestY;

                return {
                    width: [
                        {
                            title: {x: grMiddles[0].x - widthTitleSizes[0]/2, y: grMiddles[0].y - titleYShift},
                            text: {x: grMiddles[0].x - widthTextSizes[0]/2 , y: grMiddles[0].y - textYShift}
                        },
                        {
                            title: {x: grMiddles[1].x - widthTitleSizes[1]/2, y: grMiddles[1].y - titleYShift},
                            text: {x: grMiddles[1].x - widthTextSizes[1]/2 , y: grMiddles[1].y - textYShift}
                        },
                        {
                            title: {x: grMiddles[2].x - widthTitleSizes[2]/2, y: grMiddles[2].y - titleYShift},
                            text: {x: grMiddles[2].x - widthTextSizes[2]/2 , y: grMiddles[2].y - textYShift}
                        },
                        {
                            title: {x: grMiddles[3].x - widthTitleSizes[3]/2, y: grMiddles[3].y - titleYShift + allTextHeight/2},
                            text: {x: grMiddles[3].x - widthTextSizes[3]/2 , y: grMiddles[3].y - textYShift + allTextHeight/2}
                        },
                    ],
                    length: [
                        {
                            title: {x: grMiddles[0].x - lengthTitleSizes[0]/2, y: borts[0].bottom.y - arrowWidth/2 - titleYShift},
                            text: {x: grMiddles[0].x - lengthTextSizes[0]/2 , y: borts[0].bottom.y - arrowWidth/2 - textYShift}
                        },
                        {
                            title: {x: grMiddles[1].x - lengthTitleSizes[1]/2, y: lowestY - titleYShift},
                            text: {x: grMiddles[1].x - lengthTextSizes[1]/2 , y: lowestY - textYShift}
                        },
                        {
                            title: {x: grMiddles[2].x - lengthTitleSizes[2]/2, y: borts[2].bottom.y - arrowWidth/2 - titleYShift},
                            text: {x: grMiddles[2].x - lengthTextSizes[2]/2 , y: borts[2].bottom.y - arrowWidth/2 - textYShift}
                        },
                        {
                            title: {x: 0, y: 0},
                            text: {x: 0, y: 0}
                        }
                    ]
                }

            },
        }
    }
</script>

<style scoped>
    svg {
        user-select: none;
    }

    [id*="arrow"] {
        cursor: move;
        fill:none;
        fill-rule:evenodd;
        stroke:#da3a3a;
        stroke-width:0.465;
        stroke-linecap:butt;
        stroke-linejoin:miter;
        stroke-miterlimit:4;
        stroke-dasharray:none;
        stroke-opacity:1;
        marker-start:url(#ArrowStartVertical);
        marker-end:url(#ArrowEndVertical);
    }

    [id*="bottom_arrow"] {
        marker-start:url(#ArrowStartHorizontal);
        marker-end:url(#ArrowEndHorizontal);
    }

    [id*="bort"] {
        opacity:1;
        fill:none;
        fill-opacity:1;
        stroke:#000000;
        stroke-width:0.26499999;
        stroke-linecap:butt;
        stroke-linejoin:miter;
        stroke-miterlimit:4;
        stroke-dasharray:none;
        stroke-dashoffset:0;
        stroke-opacity:1;
        paint-order:normal;
    }

    [id*="title"] {
        font-style:normal;
        font-weight:normal;
        font-size:4.93888903px;
        line-height:125%;
        font-family:Sans;
        letter-spacing:0px;
        word-spacing:0px;
        fill:#000000;
        fill-opacity:1;
        stroke:none;
        stroke-width:0.26458332px;
        stroke-linecap:butt;
        stroke-linejoin:miter;
        stroke-opacity:1;
    }

    [id*="text"] {
        font-style:normal;
        font-weight:normal;
        font-size:10.58333302px;
        line-height:125%;
        font-family:Sans;
        letter-spacing:0px;
        word-spacing:0px;
        fill:#000000;
        fill-opacity:1;
        stroke:none;
        stroke-width:0.26458332px;
        stroke-linecap:butt;
        stroke-linejoin:miter;
        stroke-opacity:1;
    }

    [id*="support"] {
        fill:none;
        fill-rule:evenodd;
        stroke:#000000;
        stroke-width:0.26458332;
        stroke-linecap:butt;
        stroke-linejoin:miter;
        stroke-miterlimit:4;
        stroke-dasharray:0.52916663, 0.52916663;
        stroke-dashoffset:0;
        stroke-opacity:1;
    }

</style>